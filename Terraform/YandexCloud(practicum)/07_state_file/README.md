# –§–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è Terraform (State File)

–§–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è (`terraform.tfstate`) ‚Äî —ç—Ç–æ **—Å–µ—Ä–¥—Ü–µ Terraform**. –û–Ω —Ö—Ä–∞–Ω–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–∞–∫–∏–µ —Ä–µ—Å—É—Ä—Å—ã —É–∂–µ —Å–æ–∑–¥–∞–Ω—ã –≤ –æ–±–ª–∞–∫–µ, –∏—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –Ω–∏–º–∏.

---

## üîç –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏?

–≠—Ç–æ –æ–±—ã—á–Ω—ã–π JSON-—Ñ–∞–π–ª. –ü—Ä–∏–º–µ—Ä —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞:

```json
{
  "version": 4,
  "terraform_version": "1.6.0",
  "resources": [
    {
      "type": "yandex_compute_instance",
      "name": "web_server",
      "provider": "provider[\"yandex-cloud/yandex\"]",
      "instances": [
        {
          "attributes": {
            "name": "web-01",
            "platform_id": "standard-v3",
            "zone": "ru-central1-a",
            "network_interface": [
              {
                "ip_address": "192.168.10.5",
                "nat_ip_address": "158.160.123.57"
              }
            ],
            "status": "running"
          }
        }
      ]
    }
  ]
}
```

Terraform –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å:  
> ¬´–≠—Ç–æ—Ç –±–ª–æ–∫ `yandex_compute_instance.web_server` –≤ –º–æ—ë–º –∫–æ–¥–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –æ–±–ª–∞–∫–µ –∫–∞–∫ –í–ú —Å IP 158.160.123.57¬ª.

---

## üéØ –ó–∞—á–µ–º –æ–Ω –Ω—É–∂–µ–Ω?

### 1. **–°–≤—è–∑—å –∫–æ–¥–∞ –∏ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏**
–ë–µ–∑ state Terraform –Ω–µ –∑–Ω–∞–ª –±—ã, —á—Ç–æ —Ä–µ—Å—É—Ä—Å —É–∂–µ —Å–æ–∑–¥–∞–Ω, –∏ –ø–æ–ø—ã—Ç–∞–ª—Å—è –±—ã —Å–æ–∑–¥–∞—Ç—å –µ–≥–æ —Å–Ω–æ–≤–∞ ‚Äî —á—Ç–æ –≤—ã–∑–≤–∞–ª–æ –±—ã –æ—à–∏–±–∫—É.

### 2. **–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π**
–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ `terraform plan` Terraform:
- —á–∏—Ç–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ `tfstate`,
- —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π,
- —Å—Ç—Ä–æ–∏—Ç –ø–ª–∞–Ω: —á—Ç–æ —Å–æ–∑–¥–∞—Ç—å, –∏–∑–º–µ–Ω–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å.

### 3. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏**
–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å:
```hcl
resource "yandex_vpc_network" "main" { name = "net" }
resource "yandex_compute_instance" "vm" {
  network_interface {
    network_id = yandex_vpc_network.main.id
  }
}
```
Terraform –∑–Ω–∞–µ—Ç –∏–∑ state, —á—Ç–æ `network_id` —É–∂–µ –∏–∑–≤–µ—Å—Ç–µ–Ω, –∏ –º–æ–∂–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –í–ú.

---

## üíæ –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å state?

### ‚ùå –õ–æ–∫–∞–ª—å–Ω–æ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
–§–∞–π–ª `terraform.tfstate` –ª–µ–∂–∏—Ç –≤ –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞.

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–µ–ª—å–∑—è —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥–µ ‚Äî —É –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ–π state.
- –†–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ (–µ—Å–ª–∏ —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É ‚Äî Terraform ¬´–∑–∞–±—É–¥–µ—Ç¬ª –ø—Ä–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É, —Ö–æ—Ç—è —Ä–µ—Å—É—Ä—Å—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ –æ–±–ª–∞–∫–µ!).

### ‚úÖ –£–¥–∞–ª—ë–Ω–Ω–æ (remote state)
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **–±—ç–∫–µ–Ω–¥**. –ü—Ä–∏–º–µ—Ä –¥–ª—è Yandex Cloud:

#### 1. –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ Yandex Object Storage (S3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π):
```hcl
terraform {
  backend "s3" {
    endpoint   = "storage.yandexcloud.net"
    bucket     = "my-terraform-states"
    key        = "prod/web.tfstate"
    region     = "ru-central1"
    access_key = var.s3_access_key
    secret_key = var.s3_secret_key
  }
}
```

#### 2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π (state locking)
–ß—Ç–æ–±—ã –¥–≤–∞ –∏–Ω–∂–µ–Ω–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∏ `apply` –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ DynamoDB-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, YDB):

```hcl
terraform {
  backend "s3" {
    # ... –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    dynamodb_endpoint = "https://ydb.serverless.yandexcloud.net/..."
    dynamodb_table    = "terraform-locks"
  }
}
```

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ `apply` Terraform –±—É–¥–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å state –Ω–∞ –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–∏.

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

1. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `terraform.tfstate` –≤ Git!**  
   –î–æ–±–∞–≤—å—Ç–µ –≤ `.gitignore`:
   ```
   *.tfstate
   *.tfstate.backup
   ```

2. **–ù–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ state –≤—Ä—É—á–Ω—É—é**, –µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω—ã –Ω–∞ 100%.  
   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `terraform state` –∫–æ–º–∞–Ω–¥—ã:
   ```bash
   terraform state list          # —Å–ø–∏—Å–æ–∫ —Ä–µ—Å—É—Ä—Å–æ–≤
   terraform state show web_vm   # –¥–µ—Ç–∞–ª–∏ —Ä–µ—Å—É—Ä—Å–∞
   terraform state rm old_vm     # —É–¥–∞–ª–∏—Ç—å –∏–∑ state (–Ω–µ –∏–∑ –æ–±–ª–∞–∫–∞!)
   ```

3. **–†–µ–≥—É–ª—è—Ä–Ω–æ –¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø—ã state** (–æ—Å–æ–±–µ–Ω–Ω–æ –ø–µ—Ä–µ–¥ –∫—Ä—É–ø–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏). –£–¥–∞–ª—ë–Ω–Ω—ã–µ –±—ç–∫–µ–Ω–¥—ã –æ–±—ã—á–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.

---

## üí° –ü—Ä–∏–º–µ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è –±–µ–∑ state

–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã —É–¥–∞–ª–∏–ª–∏ `terraform.tfstate`, –Ω–æ —Ä–µ—Å—É—Ä—Å—ã –æ—Å—Ç–∞–ª–∏—Å—å –≤ Yandex Cloud.

–ï—Å–ª–∏ –≤—ã –∑–∞–ø—É—Å—Ç–∏—Ç–µ `terraform apply`:
- Terraform **—Å–æ–∑–¥–∞—Å—Ç –≤—Å—ë –∑–∞–Ω–æ–≤–æ**, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥—É–º–∞–µ—Ç, —á—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç.
- –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ ‚Äî –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å—Ç–∞—Ä—ã–µ —Ä–µ—Å—É—Ä—Å—ã (¬´–∑–æ–º–±–∏¬ª) + –Ω–æ–≤—ã–µ.

–ß—Ç–æ–±—ã —ç—Ç–æ–≥–æ –∏–∑–±–µ–∂–∞—Ç—å ‚Äî –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ **remote backend** –∏ –¥–µ–ª–∞–π—Ç–µ `terraform import`, –µ—Å–ª–∏ state —É—Ç–µ—Ä—è–Ω.

---

## üì• –§–∞–π–ª `import.tf` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–º —Ä–µ—Å—É—Ä—Å–æ–≤

–ö–æ–≥–¥–∞ –≤—ã –Ω–∞—á–∏–Ω–∞–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Terraform –¥–ª—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã, —Ä–µ—Å—É—Ä—Å—ã **–µ—â—ë –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è** Terraform. –ß—Ç–æ–±—ã ¬´–ø–æ–¥–∫–ª—é—á–∏—Ç—å¬ª –∏—Ö –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ `terraform import`.

–ù–æ —Å –≤–µ—Ä—Å–∏–∏ **Terraform 1.5+** –ø–æ—è–≤–∏–ª–∞—Å—å –ø–æ–¥–¥–µ—Ä–∂–∫–∞ **–¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞** —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –±–ª–æ–∫ `import` –≤ `.tf`-—Ñ–∞–π–ª–∞—Ö.

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª, –Ω–∞–ø—Ä–∏–º–µ—Ä `import.tf`:

```hcl
# import.tf
import {
  to = yandex_compute_instance.web_server
  id = "fhmqev1n77u9qjmlv75a"
}

import {
  to = yandex_vpc_network.main
  id = "enp3k4e83m5qgmaf7c9l"
}
```

–ó–¥–µ—Å—å:
- `to` ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ—Å—É—Ä—Å –∏–∑ –≤–∞—à–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏,
- `id` ‚Äî —Ä–µ–∞–ª—å–Ω—ã–π ID —Ä–µ—Å—É—Ä—Å–∞ –≤ –æ–±–ª–∞–∫–µ (–º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å –≤ Yandex Cloud Console –∏–ª–∏ —á–µ—Ä–µ–∑ CLI: `yc compute instance get web-01 --format json`).

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
```bash
terraform plan
```

Terraform –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –û–±–Ω–∞—Ä—É–∂–∏—Ç –±–ª–æ–∫–∏ `import`,
2. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –≤ state,
3. –°—Ä–∞–≤–Ω–∏—Ç –∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –≤–∞—à–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏ –ø–æ–∫–∞–∂–µ—Ç, –Ω—É–∂–Ω—ã –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

> üí° –≠—Ç–æ **–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π** —Å–ø–æ—Å–æ–± –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –ø–æ–¥ Terraform.

### –ü–æ—á–µ–º—É `import.tf` ‚Äî —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞?

- –ò–º–ø–æ—Ä—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á–∞—Å—Ç—å—é –∫–æ–¥–∞, –∞ –Ω–µ —Ä—É—á–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π.
- –ù–æ–≤—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è ‚Äî –≤—Å—ë –ø–æ–Ω—è—Ç–Ω–æ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
- –ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–ø–æ—Ä—Ç –≤ CI/CD –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º.
- –§–∞–π–ª –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ ‚Äî –æ–Ω –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ `apply`.

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–§–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ ¬´–∫—ç—à¬ª, –∞ **–∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã** –æ –≤–∞—à–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ.  
–§–∞–π–ª `import.tf` ‚Äî —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é.

**–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ ‚Äî –≤—Å–µ–≥–¥–∞:**
- ‚úÖ Remote backend + locking,
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `import` –¥–ª—è legacy-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã,
- ‚ùå –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `.tfstate` –≤ Git.